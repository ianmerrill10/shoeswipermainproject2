name: Agent Orchestration

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Launch mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - security
          - revenue
          - features
          - quick
  schedule:
    # Run every Monday at 6 AM UTC
    - cron: '0 6 * * 1'

permissions:
  contents: read
  issues: write

jobs:
  analyze-project:
    name: Analyze Project Health
    runs-on: ubuntu-latest
    outputs:
      todo_count: ${{ steps.analysis.outputs.todo_count }}
      any_count: ${{ steps.analysis.outputs.any_count }}
      console_log_count: ${{ steps.analysis.outputs.console_log_count }}
      affiliate_issues: ${{ steps.analysis.outputs.affiliate_issues }}
      summary: ${{ steps.analysis.outputs.summary }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Analysis
        id: analysis
        run: |
          cd shoeswiper-complete/src
          
          # Count TODOs
          TODO_COUNT=$(grep -r "TODO" --include="*.ts" --include="*.tsx" . 2>/dev/null | wc -l || echo "0")
          echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT
          
          # Count 'any' types (excluding comments)
          ANY_COUNT=$(grep -r ": any" --include="*.ts" --include="*.tsx" . 2>/dev/null | grep -v "// " | wc -l || echo "0")
          echo "any_count=$ANY_COUNT" >> $GITHUB_OUTPUT
          
          # Count unguarded console.log (not wrapped in DEV check)
          CONSOLE_COUNT=$(grep -r "console\\.log" --include="*.ts" --include="*.tsx" . 2>/dev/null | grep -v "import.meta.env.DEV" | wc -l || echo "0")
          echo "console_log_count=$CONSOLE_COUNT" >> $GITHUB_OUTPUT
          
          # Check for Amazon links missing affiliate tag
          AFFILIATE_ISSUES=$(grep -r "amazon.com" --include="*.ts" --include="*.tsx" . 2>/dev/null | grep -v "shoeswiper-20" | wc -l || echo "0")
          echo "affiliate_issues=$AFFILIATE_ISSUES" >> $GITHUB_OUTPUT
          
          # Create summary
          SUMMARY="üìä **Project Analysis**\n- TODOs: $TODO_COUNT\n- \`any\` types: $ANY_COUNT\n- Unguarded console.log: $CONSOLE_COUNT\n- Affiliate tag issues: $AFFILIATE_ISSUES"
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Display Analysis
        run: |
          echo "## Project Analysis Results"
          echo "- TODOs: ${{ steps.analysis.outputs.todo_count }}"
          echo "- any types: ${{ steps.analysis.outputs.any_count }}"
          echo "- Unguarded console.log: ${{ steps.analysis.outputs.console_log_count }}"
          echo "- Affiliate tag issues: ${{ steps.analysis.outputs.affiliate_issues }}"

  create-security-issue:
    name: Create Security Guardian Issue
    needs: analyze-project
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'security' || github.event.inputs.mode == 'quick' || github.event_name == 'schedule' }}
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üîê Security Guardian Tasks

            ${{ needs.analyze-project.outputs.summary }}

            ### Priority: P1 (Blocks Everything)

            ### Task Checklist
            - [ ] Audit all API key usage - ensure none exposed in client code
            - [ ] Review RLS policies on all Supabase tables
            - [ ] Check for hardcoded secrets or credentials
            - [ ] Verify input validation on all user inputs
            - [ ] Review authentication flows
            - [ ] Check for XSS, CSRF vulnerabilities
            - [ ] Audit third-party dependencies

            ### Critical Rules
            - ‚ö†Ô∏è No secrets with \`VITE_\` prefix
            - ‚ö†Ô∏è Gemini API only in \`supabase/functions/\`
            - ‚ö†Ô∏è Admin: \`dadsellsgadgets@gmail.com\`

            ### Files to Review
            - \`src/lib/supabaseClient.ts\`
            - \`src/hooks/useAuth.ts\`
            - \`supabase/functions/\`
            - Any file handling user data

            ---
            *Auto-generated by Agent Orchestration - Mode: ${{ github.event.inputs.mode || 'scheduled' }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîê [Agent] Security Guardian Audit',
              body: body,
              labels: ['security', 'agent-task', 'priority-critical'],
              assignees: ['copilot']
            });

  create-revenue-issue:
    name: Create Revenue Optimizer Issue
    needs: analyze-project
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'revenue' || github.event.inputs.mode == 'quick' || github.event_name == 'schedule' }}
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const affiliateIssues = '${{ needs.analyze-project.outputs.affiliate_issues }}';
            const body = `## üí∞ Revenue Optimizer Tasks

            ${{ needs.analyze-project.outputs.summary }}

            ### Priority: P2 (Critical for Business)

            ### Affiliate Tag Issues Found: ${affiliateIssues}

            ### Task Checklist
            - [ ] Verify ALL Amazon links have \`?tag=shoeswiper-20\`
            - [ ] Review purchase flow conversion points
            - [ ] Check email capture mechanisms
            - [ ] Audit referral program effectiveness
            - [ ] Identify A/B testing opportunities
            - [ ] Review Pro subscription value props

            ### Revenue Streams
            - Amazon Affiliate: \`shoeswiper-20\`
            - Marketplace: 8% standard, 12% featured
            - Pro: $9.99/month
            - Pro+: $19.99/month

            ### Files to Review
            - \`src/lib/supabaseClient.ts\` (getAffiliateUrl)
            - \`src/components/*Button*.tsx\`
            - Any component with Amazon links

            ---
            *Auto-generated by Agent Orchestration - Mode: ${{ github.event.inputs.mode || 'scheduled' }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üí∞ [Agent] Revenue Optimizer Review',
              body: body,
              labels: ['revenue', 'agent-task', 'priority-high'],
              assignees: ['copilot']
            });

  create-code-builder-issue:
    name: Create Code Builder Issue
    needs: analyze-project
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'features' || github.event_name == 'schedule' }}
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const todoCount = '${{ needs.analyze-project.outputs.todo_count }}';
            const body = `## üèóÔ∏è Code Builder Tasks

            ${{ needs.analyze-project.outputs.summary }}

            ### Priority: P3

            ### TODOs Found: ${todoCount}

            ### Task Checklist
            - [ ] Review and implement TODOs marked in code
            - [ ] Check for incomplete features
            - [ ] Identify missing components
            - [ ] Review pending integrations
            - [ ] Create any missing hooks

            ### Code Quality
            - ‚ö†Ô∏è NO \`any\` types
            - ‚ö†Ô∏è Guard console.log with \`import.meta.env.DEV\`
            - ‚ö†Ô∏è Follow existing file structure

            ### Coordinate With
            - \`security-guardian\` for secure code
            - \`react-specialist\` for patterns
            - \`supabase-expert\` for backend

            ---
            *Auto-generated by Agent Orchestration - Mode: ${{ github.event.inputs.mode || 'scheduled' }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üèóÔ∏è [Agent] Code Builder Tasks',
              body: body,
              labels: ['feature', 'agent-task', 'enhancement'],
              assignees: ['copilot']
            });

  create-react-specialist-issue:
    name: Create React Specialist Issue
    needs: analyze-project
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'features' || github.event_name == 'schedule' }}
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const anyCount = '${{ needs.analyze-project.outputs.any_count }}';
            const body = `## ‚öõÔ∏è React Specialist Tasks

            ${{ needs.analyze-project.outputs.summary }}

            ### Priority: P3

            ### \`any\` Types Found: ${anyCount}

            ### Task Checklist
            - [ ] Eliminate all \`any\` types - replace with proper interfaces
            - [ ] Review component performance
            - [ ] Check for missing \`useCallback\`/\`useMemo\`
            - [ ] Audit custom hooks for optimization
            - [ ] Review state management patterns

            ### Files to Focus
            - \`src/components/\`
            - \`src/hooks/\`
            - \`src/stores/\`

            ### Patterns to Enforce
            - Functional components only
            - Proper TypeScript interfaces
            - React Query for data fetching
            - Zustand for global state

            ---
            *Auto-generated by Agent Orchestration - Mode: ${{ github.event.inputs.mode || 'scheduled' }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚öõÔ∏è [Agent] React Specialist Review',
              body: body,
              labels: ['react', 'typescript', 'agent-task'],
              assignees: ['copilot']
            });

  create-supabase-expert-issue:
    name: Create Supabase Expert Issue
    needs: analyze-project
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'features' || github.event.inputs.mode == 'security' || github.event_name == 'schedule' }}
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üóÑÔ∏è Supabase Expert Tasks

            ${{ needs.analyze-project.outputs.summary }}

            ### Priority: P3

            ### Task Checklist
            - [ ] Review database schema optimization
            - [ ] Audit RLS policies on all tables
            - [ ] Check Edge Function security
            - [ ] Review query performance
            - [ ] Verify migrations are up to date

            ### Tables to Audit
            - profiles, shoes, brands
            - favorites, user_sneakers
            - listings, transactions, orders
            - nfts, price_alerts
            - affiliate_clicks

            ### Files to Review
            - \`supabase/functions/\`
            - \`database/\`
            - \`src/lib/supabaseClient.ts\`

            ---
            *Auto-generated by Agent Orchestration - Mode: ${{ github.event.inputs.mode || 'scheduled' }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üóÑÔ∏è [Agent] Supabase Expert Review',
              body: body,
              labels: ['database', 'backend', 'agent-task'],
              assignees: ['copilot']
            });

  create-ui-designer-issue:
    name: Create UI Designer Issue
    needs: analyze-project
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'features' || github.event_name == 'schedule' }}
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üé® UI Designer Tasks

            ${{ needs.analyze-project.outputs.summary }}

            ### Priority: P4

            ### Task Checklist
            - [ ] Review Tailwind class consistency
            - [ ] Check Framer Motion animations
            - [ ] Audit dark theme compliance (zinc-950 base)
            - [ ] Review accessibility (a11y)
            - [ ] Check mobile responsiveness

            ### Design System
            - Base: \`bg-zinc-950\`
            - Cards: \`bg-zinc-900\`
            - Accent: \`purple-500\`, \`pink-500\`
            - Touch targets: 44x44px minimum

            ### Files to Review
            - \`src/components/\`
            - Any UI with user interaction

            ---
            *Auto-generated by Agent Orchestration - Mode: ${{ github.event.inputs.mode || 'scheduled' }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üé® [Agent] UI Designer Review',
              body: body,
              labels: ['ui', 'styling', 'agent-task'],
              assignees: ['copilot']
            });

  create-devops-engineer-issue:
    name: Create DevOps Engineer Issue
    needs: analyze-project
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'security' || github.event_name == 'schedule' }}
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üöÄ DevOps Engineer Tasks

            ${{ needs.analyze-project.outputs.summary }}

            ### Priority: P4

            ### Task Checklist
            - [ ] Review CI/CD pipeline efficiency
            - [ ] Check GitHub Actions workflows
            - [ ] Audit secret management
            - [ ] Review deployment configuration
            - [ ] Check build optimization

            ### Workflows to Review
            - \`.github/workflows/ci.yml\`
            - \`.github/workflows/deploy-edge-functions.yml\`
            - \`.github/workflows/preview.yml\`
            - \`.github/workflows/production.yml\`

            ### Environment Management
            - Verify secrets are in GitHub Secrets
            - Check Vercel environment variables
            - Audit Supabase secrets

            ---
            *Auto-generated by Agent Orchestration - Mode: ${{ github.event.inputs.mode || 'scheduled' }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üöÄ [Agent] DevOps Engineer Review',
              body: body,
              labels: ['devops', 'infrastructure', 'agent-task'],
              assignees: ['copilot']
            });

  create-seo-specialist-issue:
    name: Create SEO Specialist Issue
    needs: analyze-project
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.mode == 'full' || github.event_name == 'schedule' }}
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üîç SEO Specialist Tasks

            ${{ needs.analyze-project.outputs.summary }}

            ### Priority: P5

            ### Task Checklist
            - [ ] Review meta tags on all pages
            - [ ] Check structured data (JSON-LD)
            - [ ] Audit Open Graph tags
            - [ ] Review sitemap configuration
            - [ ] Check canonical URLs

            ### SEO Requirements
            - Title: ShoeSwiper - Swipe. Discover. Cop.
            - OG Image: /og-image.png
            - Product schema for shoes
            - Organization schema

            ### Files to Review
            - \`index.html\`
            - \`src/pages/\`
            - Any page with unique content

            ---
            *Auto-generated by Agent Orchestration - Mode: ${{ github.event.inputs.mode || 'scheduled' }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîç [Agent] SEO Specialist Review',
              body: body,
              labels: ['seo', 'marketing', 'agent-task'],
              assignees: ['copilot']
            });

  create-mobile-specialist-issue:
    name: Create Mobile Specialist Issue
    needs: analyze-project
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.mode == 'full' || github.event_name == 'schedule' }}
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üì± Mobile Specialist Tasks

            ${{ needs.analyze-project.outputs.summary }}

            ### Priority: P5

            ### Task Checklist
            - [ ] Review PWA configuration
            - [ ] Check touch gesture handling
            - [ ] Audit safe area implementation
            - [ ] Review mobile responsiveness
            - [ ] Test scroll snap behavior

            ### Mobile Requirements
            - Touch targets: 44x44px
            - Full viewport: \`h-[100svh]\`
            - Safe areas: \`pb-safe\`, \`pt-safe\`
            - Snap scroll: \`snap-y snap-mandatory\`

            ### Files to Review
            - \`manifest.json\`
            - \`src/components/\` (all mobile-facing)
            - Any gesture-based interactions

            ---
            *Auto-generated by Agent Orchestration - Mode: ${{ github.event.inputs.mode || 'scheduled' }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üì± [Agent] Mobile Specialist Review',
              body: body,
              labels: ['mobile', 'pwa', 'agent-task'],
              assignees: ['copilot']
            });

  summary:
    name: Orchestration Summary
    needs: [
      analyze-project,
      create-security-issue,
      create-revenue-issue,
      create-code-builder-issue,
      create-react-specialist-issue,
      create-supabase-expert-issue,
      create-ui-designer-issue,
      create-devops-engineer-issue,
      create-seo-specialist-issue,
      create-mobile-specialist-issue
    ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## üéØ Agent Orchestration Complete"
          echo ""
          echo "### Mode: ${{ github.event.inputs.mode || 'scheduled' }}"
          echo ""
          echo "### Analysis Results"
          echo "- TODOs: ${{ needs.analyze-project.outputs.todo_count }}"
          echo "- any types: ${{ needs.analyze-project.outputs.any_count }}"
          echo "- Unguarded console.log: ${{ needs.analyze-project.outputs.console_log_count }}"
          echo "- Affiliate tag issues: ${{ needs.analyze-project.outputs.affiliate_issues }}"
          echo ""
          echo "### Issues Created"
          echo "Check the Issues tab for agent-specific tasks."
          echo ""
          echo "### Next Steps"
          echo "1. Review created issues"
          echo "2. Copilot will be auto-assigned"
          echo "3. Monitor agent progress"
          echo "4. Merge approved PRs"
